<%- include("layout", { title: "Settings", user, body: `
<div class="space-y-10">

  <h1 class="text-3xl font-bold">TV Panel Settings</h1>

    <!-- Site Settings -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">Panel Settings</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Channel Name</label>
      <input id="channelName" type="text"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Channel Owner</label>
      <input id="channelOwner" type="text"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
    <div class="space-y-2">
      <label class="block text-sm font-medium">Channel URL</label>
      <input id="channelURL" type="text"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
    <div class="flex items-center gap-2 pt-2">
      <input id="channelPublish" type="checkbox"
        class="h-4 w-4 rounded border-gray-600 bg-gray-900 text-pink-500 focus:ring-pink-500" />
      <label for="channelPublish" class="text-sm font-medium">Publish Channel (public listing)</label>
    </div>
  </div>

  <!-- Idents / Ads -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">Idents / Ads</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Ident Interval (minutes)</label>
      <input id="ident_interval_minutes" type="number" min="0"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Ad Interval (minutes)</label>
      <input id="ad_interval_minutes" type="number" min="0"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
    <div class="space-y-2">
      <label class="block text-sm font-medium">No Repeat (minutes)</label>
      <input id="no_repeat_minutes" type="number" min="0"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
  </div>

  <!-- Media -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">Last.fm API Key (get one from https://www.last.fm/api/account/create)</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">API Key</label>
      <input id="lastFMKey" type="text"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
  </div>

  <!-- YouTube Authentication -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">YouTube Authentication</h2>

    <p class="text-sm text-gray-300">
      Some YouTube videos require a logged-in session.
      FluxTV does <strong>not</strong> store your password.
      Upload a cookies.txt file exported from your browser.
    </p>

    <div class="space-y-2">
      <label class="block text-sm font-medium">cookies.txt file</label>
      <input id="ytd_cookies_file" type="file" accept=".txt"
        class="w-full text-gray-200 file:bg-purple-600 file:text-white
               file:rounded-md file:border-0 file:px-4 file:py-2
               file:hover:bg-purple-700" />
    </div>

    <div class="flex flex-wrap gap-3">
      <button type="button" onclick="uploadYtdCookies()"
        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition">
        Upload Cookies
      </button>

      <button type="button" onclick="testYtdCookies()"
        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-md transition">
        Test Authentication
      </button>

      <button type="button" onclick="openYtdHelp()"
        class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-md border border-gray-600 transition">
        Help
      </button>
    </div>

    <div id="ytd_cookie_status" class="text-sm"></div>
    <dialog id="ytd_help_modal" class="bg-transparent">
      <div class="w-full max-w-2xl bg-gray-900 text-gray-100 rounded-lg border border-gray-700 shadow-xl p-6">
        <div class="flex items-start justify-between gap-4">
          <h3 class="text-lg font-semibold">How to export YouTube cookies</h3>
          <button type="button" onclick="closeYtdHelp()"
            class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded border border-gray-600">
            Close
          </button>
        </div>

        <div class="mt-4 space-y-4 text-sm text-gray-200">
          <p>
            YouTube sometimes blocks downloads unless you have a logged-in browser session.
            FluxTV does <strong>not</strong> store your password — it only uses a cookies.txt file you export.
          </p>

          <div class="bg-gray-800 border border-gray-700 rounded p-4 space-y-3">
            <h4 class="font-semibold">Firefox (recommended)</h4>
            <ol class="list-decimal pl-5 space-y-1">
              <li>Install the <strong>cookies.txt</strong> extension from Firefox Add-ons.</li>
              <li>Open <strong>youtube.com</strong> and make sure you are logged in.</li>
              <li>Click the extension icon and export cookies for <strong>youtube.com</strong>.</li>
              <li>Save the file as <code class="px-1 bg-black/40 rounded">cookies.txt</code>.</li>
              <li>Back here: click <strong>Upload Cookies</strong>, then <strong>Test Authentication</strong>.</li>
            </ol>
          </div>

          <div class="bg-gray-800 border border-gray-700 rounded p-4 space-y-3">
            <h4 class="font-semibold">Chrome / Chromium</h4>
            <ol class="list-decimal pl-5 space-y-1">
              <li>Install a <strong>cookies.txt exporter</strong> extension (e.g. “Get cookies.txt”).</li>
              <li>Open <strong>youtube.com</strong> and make sure you are logged in.</li>
              <li>Export cookies for <strong>youtube.com</strong> and save as <code class="px-1 bg-black/40 rounded">cookies.txt</code>.</li>
              <li>Back here: click <strong>Upload Cookies</strong>, then <strong>Test Authentication</strong>.</li>
            </ol>
          </div>

          <div class="bg-gray-800 border border-gray-700 rounded p-4 space-y-2">
            <h4 class="font-semibold">Troubleshooting</h4>
            <ul class="list-disc pl-5 space-y-1 text-gray-300">
              <li>If Test Authentication fails, re-export cookies and try again.</li>
              <li>If you log out of YouTube, cookies stop working (re-export them).</li>
              <li>Keep cookies private — treat them like a password.</li>
            </ul>
          </div>

          <p class="text-xs text-gray-400">
            This uses yt-dlp’s official cookie support. Docs: <span class="underline">https://github.com/yt-dlp/yt-dlp/wiki/FAQ#how-do-i-pass-cookies-to-yt-dlp</span>
          </p>
        </div>
      </div>
    </dialog>
  </div>

  <!-- Video Output Settings -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">Video Output Settings</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">FPS</label>
      <select id="default_fps"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500">
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="50">50</option>
        <option value="60">60</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Resolution</label>
      <select id="default_resolution"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500">
        <option value="854x480">854×480</option>
        <option value="1280x720">1280×720</option>
        <option value="1920x1080">1920×1080</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Video Bitrate</label>
      <select id="bitrate_video"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500">
        <option value="1500k">1500k</option>
        <option value="2500k">2500k</option>
        <option value="5000k">5000k</option>
        <option value="8000k">8000k</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Audio Bitrate</label>
      <select id="bitrate_audio"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500">
        <option value="96k">96k</option>
        <option value="128k">128k</option>
        <option value="160k">160k</option>
        <option value="192k">192k</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Video Buffer Size</label>
      <select id="buffer_size"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500">
        <option value="5000k">5000k</option>
        <option value="10000k">10000k</option>
        <option value="20000k">20000k</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block text-sm font-medium">Logo</label>
      <input id="logo" type="file"
        class="w-full text-gray-200 file:bg-purple-600 file:text-white file:rounded-md file:border-0 file:px-4 file:py-2 file:hover:bg-purple-700" />
    </div>
  </div>

  <!-- Output Stream -->
  <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4 max-w-xl">
    <h2 class="text-xl font-semibold">Output Stream</h2>

    <div class="space-y-2">
      <label class="block text-sm font-medium">RTMP Output URL</label>
      <input id="output_rtmp_url" type="text"
        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:ring-2 focus:ring-pink-500" />
    </div>
  </div>

  <button onclick="saveSettings()"
    class="px-5 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition">
    Save Settings
  </button>

  <div id="status" class="mt-4 text-lg"></div>

  <script>
async function loadSettings() {
  const res = await fetch("/api/settings");
  const data = await res.json();
  if (!data.ok) return;

  const s = data.settings;
  document.getElementById("channelName").value = s.channelName || "";
  document.getElementById("channelOwner").value = s.channelOwner || "";
  document.getElementById("channelURL").value = s.channelURL || "";
  document.getElementById("channelPublish").checked = s.channelPublish === "true";
  document.getElementById("ident_interval_minutes").value = s.ident_interval_minutes || "";
  document.getElementById("ad_interval_minutes").value = s.ad_interval_minutes || "";
  document.getElementById("no_repeat_minutes").value = s.no_repeat_minutes || "";
  document.getElementById("lastFMKey").value = s.lastFMKey || "";
  document.getElementById("default_fps").value = s.default_fps || "";
  document.getElementById("default_resolution").value = s.default_resolution || "";
  document.getElementById("bitrate_video").value = s.bitrate_video || "";
  document.getElementById("bitrate_audio").value = s.bitrate_audio || "";
  document.getElementById("buffer_size").value = s.buffer_size || "";
  document.getElementById("output_rtmp_url").value = s.output_rtmp_url || "";
}

async function saveSettings() {
  const form = new FormData();

  form.append("channelName", document.getElementById("channelName").value);
  form.append("channelOwner", document.getElementById("channelOwner").value);
  form.append("channelURL", document.getElementById("channelURL").value);
  form.append("channelPublish", document.getElementById("channelPublish").checked ? "true" : "false");
  form.append("ident_interval_minutes", document.getElementById("ident_interval_minutes").value);
  form.append("ad_interval_minutes", document.getElementById("ad_interval_minutes").value);
  form.append("no_repeat_minutes", document.getElementById("no_repeat_minutes").value);
  form.append("lastFMKey", document.getElementById("lastFMKey").value);
  form.append("default_fps", document.getElementById("default_fps").value);
  form.append("default_resolution", document.getElementById("default_resolution").value);
  form.append("bitrate_video", document.getElementById("bitrate_video").value);
  form.append("bitrate_audio", document.getElementById("bitrate_audio").value);
  form.append("buffer_size", document.getElementById("buffer_size").value);
  form.append("output_rtmp_url", document.getElementById("output_rtmp_url").value);

  const logoInput = document.getElementById("logo");
  if (logoInput.files.length > 0) {
    form.append("logo", logoInput.files[0]);
  }

  const res = await fetch("/api/settings", {
    method: "POST",
    body: form
  });

  const data = await res.json();
  const status = document.getElementById("status");

  if (data.ok) {
    status.innerText = "Saved successfully!";
    status.style.color = "lightgreen";
  } else {
    status.innerText = "Error saving settings.";
    status.style.color = "red";
  }
}

async function uploadYtdCookies() {
  const fileInput = document.getElementById("ytd_cookies_file");
  const status = document.getElementById("ytd_cookie_status");

  if (!fileInput.files.length) {
    status.textContent = "Please select a cookies.txt file.";
    status.style.color = "orange";
    return;
  }

  const form = new FormData();
  form.append("cookies", fileInput.files[0]);

  const res = await fetch("/api/ytdlp/cookies", {
    method: "POST",
    body: form
  });

  const data = await res.json();

  if (data.ok) {
    status.textContent = "Cookies uploaded successfully.";
    status.style.color = "lightgreen";
  } else {
    status.textContent = data.error || "Failed to upload cookies.";
    status.style.color = "red";
  }
}

async function testYtdCookies() {
  const status = document.getElementById("ytd_cookie_status");
  status.textContent = "Testing authentication…";
  status.style.color = "white";

  const res = await fetch("/api/ytdlp/test");
  const data = await res.json();

  if (data.ok) {
    status.textContent = "YouTube authentication OK.";
    status.style.color = "lightgreen";
  } else {
    status.textContent = data.error || "Authentication failed.";
    status.style.color = "red";
  }
}

function openYtdHelp() {
  const dlg = document.getElementById("ytd_help_modal");
  if (!dlg) return;
  if (typeof dlg.showModal === "function") dlg.showModal();
}

function closeYtdHelp() {
  const dlg = document.getElementById("ytd_help_modal");
  if (!dlg) return;
  dlg.close();
}

// close help on backdrop click
document.addEventListener("click", (e) => {
  const dlg = document.getElementById("ytd_help_modal");
  if (!dlg || !dlg.open) return;
  const rect = dlg.getBoundingClientRect();
  const inDialog =
    e.clientX >= rect.left && e.clientX <= rect.right &&
    e.clientY >= rect.top && e.clientY <= rect.bottom;
  if (!inDialog) dlg.close();
});

loadSettings();
  </script>

</div>
` }) %>
