<%- include("layout", { title: "Dashboard" , user, body: `

<section class="max-w-6xl mx-auto px-0 sm:px-0 mt-2 grid lg:grid-cols-[minmax(0,1.3fr)_minmax(0,1fr)] gap-10 items-center">

</section>

<section class="mt-16 grid gap-8 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,0.8fr)]">
  <div class="bg-black/40 border border-white/10 rounded-3xl p-6 space-y-5 shadow-[0_0_35px_rgba(12,3,24,0.8)]">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm uppercase tracking-[0.35em] text-purple-300/70">Live preview</p>
        <h2 class="text-2xl font-semibold mt-1">Channel Monitor</h2>
      </div>
      <span class="inline-flex items-center gap-2 text-xs text-emerald-300 bg-emerald-500/10 px-3 py-1 rounded-full">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-300 animate-pulse"></span>
        Streaming
      </span>
    </div>
    <div class="rounded-2xl overflow-hidden border border-white/10 bg-black/80 relative">
      <video id="channelPreview" class="w-full h-full aspect-video bg-black/80" controls autoplay muted playsinline></video>
      <div id="previewFallback" class="hidden absolute inset-0 flex flex-col items-center justify-center gap-2 bg-black/90 text-sm text-purple-100">
        <span data-fallback-text>Loading preview…</span>
        <a href="/public/hls/index.m3u8" class="text-purple-300 underline hover:text-purple-100 text-xs">Open stream directly</a>
      </div>
    </div>

  </div>

  <div class="bg-black/35 border border-white/10 rounded-3xl p-6 space-y-4">
    <div>
      <p class="text-sm uppercase tracking-[0.35em] text-purple-300/70">Status</p>
      <h2 class="text-xl font-semibold mt-1">Now Playing Data</h2>
    </div>
    <pre id="nowPlaying" class="p-4 bg-black/60 border border-white/10 rounded-xl text-xs text-purple-100/90 h-64 overflow-auto">Loading…</pre>
  </div>
</section>

<section class="mt-12 grid gap-8 lg:grid-cols-2">
  <div class="bg-black/35 border border-white/10 rounded-3xl p-6 space-y-4">
    <div>
      <p class="text-sm uppercase tracking-[0.35em] text-purple-300/70">Playlists</p>
      <h2 class="text-2xl font-semibold mt-1">Rotation Blocks</h2>
    </div>
    <div id="playlists" class="space-y-3 text-sm"></div>
  </div>

  <div class="bg-black/35 border border-white/10 rounded-3xl p-6 space-y-5">
    <div>
      <p class="text-sm uppercase tracking-[0.35em] text-purple-300/70">Create</p>
      <h2 class="text-2xl font-semibold mt-1">New Playlist</h2>
    </div>
    <form id="newPlaylistForm" class="space-y-4">
      <input type="text" name="name" placeholder="New playlist name" required
        class="w-full px-4 py-2.5 bg-black/70 border border-white/10 rounded-xl focus:ring-2 focus:ring-purple-500 focus:outline-none" />

      <input type="text" name="description" placeholder="Description (optional)"
        class="w-full px-4 py-2.5 bg-black/70 border border-white/10 rounded-xl focus:ring-2 focus:ring-purple-500 focus:outline-none" />

      <button type="submit"
        class="w-full inline-flex items-center justify-center px-4 py-2.5 rounded-xl bg-gradient-to-r from-purple-500 to-fuchsia-500 font-semibold shadow-neon hover:brightness-110 transition">
        Add Playlist
      </button>
    </form>
  </div>
</section>

<script>
  const previewEl = document.getElementById("channelPreview");
  const fallbackEl = document.getElementById("previewFallback");
  const previewSrc = "/public/hls/index.m3u8";

  function showPreviewFallback(message) {
    if (previewEl) previewEl.classList.add("hidden");
    if (fallbackEl) {
      const textNode = fallbackEl.querySelector("[data-fallback-text]");
      if (textNode) textNode.textContent = message || "Preview unavailable.";
      fallbackEl.classList.remove("hidden");
    }
  }

  if (previewEl) {
    const ensurePlays = () => {
      const attempt = previewEl.play();
      if (attempt && typeof attempt.catch === "function") {
        attempt.catch(() => {});
      }
    };

    if (previewEl.canPlayType("application/vnd.apple.mpegurl")) {
      previewEl.src = previewSrc;
      previewEl.addEventListener("loadedmetadata", ensurePlays, { once: true });
    } else if (window.Hls && window.Hls.isSupported()) {
      const hls = new Hls({ enableWorker: true });
      hls.loadSource(previewSrc);
      hls.attachMedia(previewEl);
      hls.on(Hls.Events.MANIFEST_PARSED, ensurePlays);
      hls.on(Hls.Events.ERROR, (event, data) => {
        if (data && data.fatal) {
          hls.destroy();
          showPreviewFallback("Preview unavailable right now.");
        }
      });
    } else {
      showPreviewFallback("Your browser does not support HLS preview.");
    }
  }
</script>

<script>
  const videoModal = document.getElementById("videoModal");
  const videoModalTitle = document.getElementById("videoModalTitle");
  const videoModalContent = document.getElementById("videoModalContent");
  const videoModalCancel = document.getElementById("videoModalCancel");
  const videoModalConfirm = document.getElementById("videoModalConfirm");

  if (videoModal && videoModalTitle && videoModalContent && videoModalCancel && videoModalConfirm) {
    window.openVideoModal = (title, contentHTML, confirmCallback) => {
      videoModalTitle.textContent = title;
      videoModalContent.innerHTML = contentHTML;

      function cleanup() {
        videoModalConfirm.removeEventListener("click", onConfirm);
        videoModalCancel.removeEventListener("click", onCancel);
      }

      function onConfirm() {
        confirmCallback();
        cleanup();
        videoModal.close();
      }

      function onCancel() {
        cleanup();
        videoModal.close();
      }

      videoModalConfirm.addEventListener("click", onConfirm);
      videoModalCancel.addEventListener("click", onCancel);

      videoModal.showModal();
    };
  }
</script>
` }) %>
