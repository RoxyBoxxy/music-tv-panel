<% const navLinks = [
  { href: "/", label: "Dashboard" },
  { href: "/media", label: "Media" },
  { href: "/playlists", label: "Playlists" },
  { href: "/users", label: "Users" },
  { href: "/settings", label: "Settings" }
]; %>
<% const activePath = typeof currentPath === "string" ? currentPath : (typeof req !== "undefined" && req.path ? req.path : ""); %>

<header class="fixed top-0 inset-x-0 z-20 bg-black/40 backdrop-blur-lg border-b border-white/5">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
    <a href="/" class="flex items-center group">
      <div class="h-15 w-20 flex items-center justify-center group-hover:scale-105 transition">
        <img src="/public/img/logo.png" alt="FluxTV" class="h-20 w-auto object-contain" />
      </div>
    </a>

    <% if (user) { %>
    <nav class="hidden sm:flex items-center gap-6 text-sm">
      <% navLinks.forEach((link) => { %>
        <a
          href="<%= link.href %>"
          class="nav-link transition font-medium <%= activePath === link.href ? 'text-purple-300' : 'text-gray-300 hover:text-gray-100' %>"
        >
          <%= link.label %>
        </a>
      <% }) %>
    </nav>

    <div class="flex items-center gap-4">
      <div id="ffmpeg-status"
        class="hidden md:flex items-center gap-4 text-xs bg-black/40 border border-white/10 rounded-full px-4 py-2 shadow-lg shadow-purple-900/30">
        <div class="flex items-center gap-2">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></span>
          <span id="status" class="font-semibold">OFF AIR</span>
        </div>
        <div class="text-gray-400">FPS <span id="fps" class="text-gray-200">--</span></div>
        <div class="text-gray-400">LIVE <span id="live-time" class="text-gray-200">--:--</span></div>
        <button id="ffmpeg-toggle"
          class="ml-2 px-3 py-1 rounded-full bg-gray-800 hover:bg-gray-700 text-[11px] font-semibold transition">
          START
        </button>
      </div>

      <form method="post" action="/logout" class="hidden sm:block">
        <button type="submit"
          class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-full text-sm font-semibold shadow-lg shadow-purple-900/40 transition">
          Logout (<%= user.username %>)
        </button>
      </form>
    </div>
    <% } %>
  </div>
</header>

<div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
  <div class="absolute -top-40 -left-20 w-80 h-80 bg-purple-700/40 rounded-full blur-3xl animate-pulse"></div>
  <div class="absolute top-1/3 -right-32 w-96 h-96 bg-fuchsia-600/40 rounded-full blur-3xl animate-pulse" style="animation-delay: -4s;"></div>
  <div class="absolute bottom-[-10rem] left-1/2 -translate-x-1/2 w-[32rem] h-[32rem] bg-indigo-700/40 rounded-full blur-3xl animate-pulse" style="animation-delay: -8s;"></div>
</div>
<script type="module">
  const statusEl = document.getElementById("status");
  const fpsEl = document.getElementById("fps");
  const liveEl = document.getElementById("live-time");
  const dotEl = document.getElementById("status-dot");
  const toggleBtn = document.getElementById("ffmpeg-toggle");

  if (statusEl && fpsEl && liveEl && dotEl && toggleBtn) {
    const wsProto = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProto}://${location.host}/api/ffmpeg/stats`);

    ws.onmessage = (e) => {
      const stats = JSON.parse(e.data);

      if (stats.running) {
        statusEl.textContent = "ON AIR";
        dotEl.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
        toggleBtn.textContent = "STOP";
        toggleBtn.className = "ml-2 px-3 py-1 rounded-full bg-red-600 hover:bg-red-700 text-[11px] font-semibold transition";
        toggleBtn.onclick = () => fetch("/api/ffmpeg/stop", { method: "POST" });
      } else {
        statusEl.textContent = "OFF AIR";
        dotEl.className = "w-2 h-2 rounded-full bg-red-500";
        toggleBtn.textContent = "START";
        toggleBtn.className = "ml-2 px-3 py-1 rounded-full bg-green-600 hover:bg-green-700 text-[11px] font-semibold transition";
        toggleBtn.onclick = () => fetch("/api/ffmpeg/start", { method: "POST" });
      }

      fpsEl.textContent = stats.fps ? Number(stats.fps).toFixed(1) : "--";

      if (stats.out_time) {
        const raw = stats.out_time.split(".")[0];
        const [hh, mm] = raw.split(":").map(Number);

        if (hh >= 24) {
          const days = Math.floor(hh / 24);
          const remHours = hh % 24;
          liveEl.textContent = `${days} Day${days !== 1 ? "s" : ""} ${String(remHours).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
        } else {
          liveEl.textContent = `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
        }
      } else {
        liveEl.textContent = "--:--";
      }
    };

    ws.onclose = () => {
      statusEl.textContent = "DISCONNECTED";
      dotEl.className = "w-2 h-2 rounded-full bg-gray-500";
      fpsEl.textContent = "--";
      liveEl.textContent = "--:--";
      toggleBtn.textContent = "START";
      toggleBtn.className = "ml-2 px-3 py-1 rounded-full bg-gray-700 text-[11px] font-semibold opacity-50 cursor-not-allowed";
      toggleBtn.onclick = null;
    };
  }
</script>
